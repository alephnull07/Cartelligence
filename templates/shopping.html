{% extends "base.html" %}

{% block title %}Shopping List{% endblock %}

{% block content %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping - Cartelligence</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .feature-card {
            border: none;
            border-radius: 12px;
            transition: transform 0.2s, box-shadow 0.2s;
            height: 100%;
            background-color: #ffffff;
        }

        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .feature-icon {
            font-size: 2.5rem;
            color: #2e5233;
            margin-bottom: 1rem;
        }

        .feature-card .card-header {
            background-color: #4a7a50;
            color: white;
            font-weight: 500;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }

        .result-card {
            display: none;
            border-radius: 12px;
            margin-top: 25px;
            border: none;
        }

        .result-card .card-header {
            background-color: #2e5233;
            color: white;
        }

        .nutrition-table th {
            background-color: #f0f7ed;
        }

        .btn-feature {
            background-color: #4a7a50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
        }

        .btn-feature:hover {
            background-color: #2e5233;
            color: white;
        }

        .shopping-header {
            background-color: #2e5233;
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
        }
    </style>
</head>

<body style="background-color: #f5ece5; font-family: 'Roboto', sans-serif;">

    <!-- Main Content -->
    <div class="container pt-3 pb-5">
        <!-- Shopping Header -->
        <div class="shopping-header mb-4 d-flex justify-content-between align-items-center">
            <div>
                <h1 class="mb-0">Smart Shopping</h1>
                <p class="lead mb-0">Make better shopping decisions with AI-powered insights</p>
            </div>
            <i class="bi bi-cart4" style="font-size: 2.5rem;"></i>
        </div>

        <!-- Features Section -->
        <div class="row g-4 mb-4">
            <!-- Alternative Ingredient Card -->
            <div class="col-lg-6">
                <div class="card feature-card shadow-sm">
                    <div class="card-header py-3">
                        <h4 class="mb-0"><i class="bi bi-arrow-repeat me-2"></i>Find Alternatives</h4>
                    </div>
                    <div class="card-body d-flex flex-column">
                        <div class="text-center mb-3">
                            <i class="bi bi-shuffle feature-icon"></i>
                            <h5>Ingredient Alternatives</h5>
                            <p class="text-muted">Find healthier or budget-friendly substitutes for any ingredient</p>
                        </div>
                        <div class="mt-auto">
                            <div class="input-group">
                                <input type="text" class="form-control" id="alternativeInput"
                                    placeholder="e.g., dairy milk, white flour, sugar">
                                <button class="btn btn-feature" id="alternativeBtn" type="button">
                                    <i class="bi bi-search me-2"></i>Find Alternatives
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Nutrition Insights Card -->
            <div class="col-lg-6">
                <div class="card feature-card shadow-sm">
                    <div class="card-header py-3">
                        <h4 class="mb-0"><i class="bi bi-pie-chart-fill me-2"></i>Nutrition Insights</h4>
                    </div>
                    <div class="card-body d-flex flex-column">
                        <div class="text-center mb-3">
                            <i class="bi bi-clipboard2-pulse feature-icon"></i>
                            <h5>Nutritional Information</h5>
                            <p class="text-muted">Get detailed nutrition facts and health benefits</p>
                        </div>
                        <div class="mt-auto">
                            <div class="input-group">
                                <input type="text" class="form-control" id="nutritionInput"
                                    placeholder="e.g., avocado, quinoa, salmon">
                                <button class="btn btn-feature" id="nutritionBtn" type="button">
                                    <i class="bi bi-search me-2"></i>Get Nutrition Info
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="row mt-4">
            <div class="col-12">
                <!-- Alternative Results Card -->
                <div class="card result-card shadow-sm mb-4" id="alternativeResultCard">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-arrow-repeat me-2"></i>Alternative Options</h5>
                        <button type="button" class="btn-close btn-close-white" aria-label="Close"
                            onclick="document.getElementById('alternativeResultCard').style.display = 'none';"></button>
                    </div>
                    <div class="card-body">
                        <div id="alternativeLoader" class="text-center py-5" style="display: none;">
                            <div class="spinner-border text-success" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Finding the best alternatives...</p>
                        </div>
                        <div class="row" id="ai-alternative-container">
                            <div class="col-12">
                                <div id="ai-alternative"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Nutrition Results Card -->
                <div class="card result-card shadow-sm" id="nutritionResultCard">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-pie-chart-fill me-2"></i>Nutrition Information</h5>
                        <button type="button" class="btn-close btn-close-white" aria-label="Close"
                            onclick="document.getElementById('nutritionResultCard').style.display = 'none';"></button>
                    </div>
                    <div class="card-body">
                        <div id="nutritionLoader" class="text-center py-5" style="display: none;">
                            <div class="spinner-border text-success" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Analyzing nutritional data...</p>
                        </div>
                        <div class="row" id="ai-nutrition-container">
                            <div class="col-12">
                                <div id="ai-nutrition"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Alternative ingredients functionality
        document.getElementById("alternativeBtn").addEventListener("click", function () {
            let userInput = document.getElementById("alternativeInput").value.trim();

            if (userInput !== "") {
                // Show loading state and result card
                document.getElementById("alternativeLoader").style.display = "block";
                document.getElementById("alternativeResultCard").style.display = "block";
                document.getElementById("ai-alternative").innerHTML = "";

                fetch('/submit_alternative', {
                    method: 'POST',
                    body: JSON.stringify({ alternative: userInput }),
                    headers: { 'Content-Type': 'application/json' }
                })
                    .then(response => response.json())
                    .then(data => {
                        // Format the response better
                        let formattedResponse = formatAlternativeResponse(data, userInput);
                        document.getElementById("ai-alternative").innerHTML = formattedResponse;
                        document.getElementById("alternativeLoader").style.display = "none";
                    })
                    .catch(error => {
                        console.error("Error:", error);
                        document.getElementById("alternativeLoader").style.display = "none";
                        document.getElementById("ai-alternative").innerHTML = `
                        <div class="alert alert-danger">
                            Sorry, there was an error processing your request. Please try again.
                        </div>
                    `;
                    });
            } else {
                alert("Please enter an ingredient.");
            }
        });

        // Nutrition information functionality
        document.getElementById("nutritionBtn").addEventListener("click", function () {
            let userInput = document.getElementById("nutritionInput").value.trim();

            if (userInput !== "") {
                // Show loading state and result card
                document.getElementById("nutritionLoader").style.display = "block";
                document.getElementById("nutritionResultCard").style.display = "block";
                document.getElementById("ai-nutrition").innerHTML = "";

                fetch('/submit_nutrition', {
                    method: 'POST',
                    body: JSON.stringify({ nutrition: userInput }),
                    headers: { 'Content-Type': 'application/json' }
                })
                    .then(response => response.json())
                    .then(data => {
                        // Format the response better
                        let formattedResponse = formatNutritionResponse(data, userInput);
                        document.getElementById("ai-nutrition").innerHTML = formattedResponse;
                        document.getElementById("nutritionLoader").style.display = "none";
                    })
                    .catch(error => {
                        console.error("Error:", error);
                        document.getElementById("nutritionLoader").style.display = "none";
                        document.getElementById("ai-nutrition").innerHTML = `
                        <div class="alert alert-danger">
                            Sorry, there was an error processing your request. Please try again.
                        </div>
                    `;
                    });
            } else {
                alert("Please enter an ingredient.");
            }
        });

        // Improved helper function to format alternative response
        function formatAlternativeResponse(data, originalIngredient) {
            // Check if data is a string (backward compatibility)
            if (typeof data === 'string') {
                // Parse the text response into a more structured format
                try {
                    // Look for common patterns in LLM responses
                    const alternatives = parseTextIntoAlternatives(data);

                    let html = `
                        <div class="mb-5">
                            <h4 class="mb-4 fw-bold text-success border-bottom pb-3">
                                <i class="bi bi-arrow-left-right me-2"></i>
                                Alternatives for ${originalIngredient}
                            </h4>
                            <div class="row row-cols-1 row-cols-md-${alternatives.length <= 2 ? '2' : '3'} g-4">
                    `;

                    alternatives.forEach((alt, index) => {
                        // Define a set of vibrant but earthy colors for the cards
                        const bgColors = ['#e8f5e9', '#f1f8e9', '#dcedc8', '#f0f4c3', '#e8f5e9'];
                        const borderColors = ['#66bb6a', '#7cb342', '#9ccc65', '#8bc34a', '#689f38'];
                        const iconColors = ['#43a047', '#558b2f', '#689f38', '#33691e', '#1b5e20'];

                        const colorIndex = index % bgColors.length;

                        html += `
                            <div class="col">
                                <div class="card h-100 border-0 shadow-sm rounded-4 overflow-hidden" style="transition: transform 0.2s;">
                                    <div class="card-header py-3 bg-white border-bottom">
                                        <div class="d-flex align-items-center">
                                            <div class="rounded-circle p-2 me-3" style="background-color: ${bgColors[colorIndex]};">
                                                <i class="bi bi-shuffle text-success" style="font-size: 1.25rem; color: ${iconColors[colorIndex]} !important;"></i>
                                            </div>
                                            <h5 class="card-title mb-0 fw-bold" style="color: #2e5233;">${alt.name}</h5>
                                        </div>
                                    </div>
                                    <div class="card-body p-4" style="border-left: 4px solid ${borderColors[colorIndex]};">
                                        <p class="card-text mb-3 lead" style="font-size: 1rem;">${alt.description}</p>
                                        ${alt.benefits ? `
                                        <div class="mt-3 pt-2 border-top">
                                            <div class="d-flex align-items-center mb-2">
                                                <span class="badge rounded-pill bg-success-subtle text-success px-3 py-2">
                                                    <i class="bi bi-heart-pulse-fill me-1"></i> Benefits
                                                </span>
                                            </div>
                                            <p class="card-text small fw-light fst-italic mb-0">${alt.benefits}</p>
                                        </div>` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    });

                    html += `
                        </div>
                        <div class="mt-4 p-3 rounded-4 bg-success bg-opacity-10 shadow-sm">
                            <div class="d-flex align-items-start">
                                <i class="bi bi-lightbulb-fill text-success me-3 mt-1 fs-5"></i>
                                <div>
                                    <p class="fw-medium text-success mb-1">Cooking Tip</p>
                                    <p class="mb-0 small">These alternatives are carefully selected based on nutritional profile and flavor compatibility. Quantities may need adjustment when substituting.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                    return html;
                } catch (e) {
                    console.error("Error parsing alternatives:", e);
                    // Fallback simple formatting if parsing fails
                    return `
                        <div class="mb-4 p-4 bg-light rounded-4 shadow-sm">
                            <h4 class="mb-4 fw-bold text-success">
                                <i class="bi bi-arrow-left-right me-2"></i>
                                Alternatives for ${originalIngredient}
                            </h4>
                            <div class="p-3 bg-white rounded-3 border">
                                ${data.replace(/##\s*\d+\.\s*/g, '<h5 class="mt-4 text-success">').replace(/\n\n/g, '</p><p>').replace(/\n/g, '<br>')}
                            </div>
                        </div>
                    `;
                }
            }

            // For structured data (preferred)
            // Rest of function remains similar...
        }

        // Improved helper function to format nutrition response
        function formatNutritionResponse(data, ingredient) {
            // Check if data is a string (backward compatibility)
            if (typeof data === 'string') {
                // Try to parse the text into structured nutrition data
                try {
                    const nutritionData = parseTextIntoNutrition(data, ingredient);

                    let html = `
                        <div class="nutrition-container mb-4">
                            <h4 class="mb-4 fw-bold text-success border-bottom pb-3">
                                <i class="bi bi-clipboard2-pulse me-2"></i>
                                Nutrition Facts: ${ingredient}
                            </h4>
                            <div class="row g-4">
                                <div class="col-lg-5 col-md-6">
                                    <div class="card shadow-sm mb-4 border-0 rounded-4 overflow-hidden">
                                        <div class="card-header bg-success py-3 text-white">
                                            <div class="d-flex align-items-center">
                                                <div class="rounded-circle bg-white p-2 me-3">
                                                    <i class="bi bi-pie-chart-fill text-success" style="font-size: 1.25rem;"></i>
                                                </div>
                                                <div>
                                                    <h5 class="mb-0">Nutritional Values</h5>
                                                    <small>Per 100g serving</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="card-body p-0">
                                            <ul class="list-group list-group-flush">
                    `;

                    // Add each nutrition item with icons
                    const nutriIcons = {
                        'calories': 'fire',
                        'protein': 'egg-fill',
                        'carbohydrates': 'subtract',
                        'fat': 'droplet-fill',
                        'fiber': 'flower1',
                        'sugar': 'cup-hot-fill',
                        'sodium': 'dash-circle-fill',
                        'vitamin': 'capsule',
                        'mineral': 'gem',
                        'calcium': 'disc',
                        'iron': 'shield-fill-check',
                        'potassium': 'lightning-charge-fill'
                    };

                    nutritionData.nutrition.forEach(item => {
                        let icon = 'circle-fill';

                        // Find matching icon
                        for (const [key, iconName] of Object.entries(nutriIcons)) {
                            if (item.name.toLowerCase().includes(key)) {
                                icon = iconName;
                                break;
                            }
                        }

                        html += `
                            <li class="list-group-item d-flex justify-content-between align-items-center border-start-0 border-end-0">
                                <div class="d-flex align-items-center">
                                    <span class="bg-light rounded-circle p-2 me-2">
                                        <i class="bi bi-${icon} text-success"></i>
                                    </span>
                                    <span>${item.name}</span>
                                </div>
                                <span class="badge rounded-pill bg-light text-dark px-3 py-2 fs-6">${item.value} ${item.unit}</span>
                            </li>
                        `;
                    });

                    html += `
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-7 col-md-6">
                                    <div class="card shadow-sm mb-4 border-0 rounded-4 overflow-hidden">
                                        <div class="card-header bg-success py-3 text-white">
                                            <div class="d-flex align-items-center">
                                                <div class="rounded-circle bg-white p-2 me-3">
                                                    <i class="bi bi-heart-fill text-success" style="font-size: 1.25rem;"></i>
                                                </div>
                                                <h5 class="mb-0">Health Benefits</h5>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <ul class="list-unstyled mb-0">
                    `;

                    nutritionData.benefits.forEach(benefit => {
                        // Final cleaning to ensure no asterisks or other unwanted characters
                        const cleanBenefit = benefit
                            .replace(/\*/g, '')
                            .replace(/^\s*-\s*|\s*•\s*|\s*\d+\.\s*/g, '')
                            .trim();
                        
                        html += `
                            <li class="mb-3 d-flex align-items-start">
                                <span class="bg-success-subtle p-2 rounded-circle me-3 mt-1">
                                    <i class="bi bi-check-lg text-success"></i>
                                </span>
                                <span>${cleanBenefit}</span>
                            </li>
                        `;
                    });

                    html += `
                                            </ul>
                                        </div>
                                    </div>
                                    ${nutritionData.description ? `
                                    <div class="card shadow-sm border-0 rounded-4 overflow-hidden">
                                        <div class="card-header bg-success py-3 text-white">
                                            <div class="d-flex align-items-center">
                                                <div class="rounded-circle bg-white p-2 me-3">
                                                    <i class="bi bi-info-circle-fill text-success" style="font-size: 1.25rem;"></i>
                                                </div>
                                                <h5 class="mb-0">Key Information</h5>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <p class="mb-0 lead" style="font-size: 1rem;">${nutritionData.description}</p>
                                        </div>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;

                    return html;
                } catch (e) {
                    // Fallback formatting if parsing fails
                    console.error("Error parsing nutrition text:", e);
                    return `
                        <div class="mb-4 p-4 bg-light rounded-4 shadow-sm">
                            <h4 class="mb-4 fw-bold text-success">
                                <i class="bi bi-clipboard2-pulse me-2"></i>
                                Nutrition Facts: ${ingredient}
                            </h4>
                            <div class="p-3 bg-white rounded-3 border">
                                ${data.replace(/##\s*[^#\n]+/g, match => `<h5 class="mt-4 text-success">${match.replace(/^##\s*/, '')}</h5>`).replace(/\n\n/g, '</p><p>').replace(/\n-\s*/g, '<br>• ').replace(/\n/g, '<br>')}
                            </div>
                        </div>
                    `;
                }
            }

            // For structured data (preferred)
            // Rest of function remains similar...
        }

        // Improved helper function to parse LLM text responses into structured alternative data
        function parseTextIntoAlternatives(text) {
            const alternatives = [];

            // Clean up markdown and other symbols from the text
            text = text
                .replace(/\*\*/g, '')     // Remove bold markdown
                .replace(/\*/g, '')       // Remove asterisks/italic markdown
                .replace(/^##+\s*/gm, '') // Remove heading markers
                .trim();

            // First check for clearly structured alternatives with headings or numbers
            const alternativePatterns = [
                /(?:^|\n)(?:\d+\.)\s*([A-Za-z][^:\n]+)(?::|–|-)?\s*/g,       // Numbered items: 1. Product Name
                /(?:^|\n)(?:•|-)\s+([A-Za-z][^:\n]+)(?::|–|-)?\s*/g,         // Bullet points: • Product Name or - Product Name
                /(?:^|\n)([A-Za-z][^:\n]{3,50})(?::|–|-)\s*/g               // Product Name: description
            ];

            let foundAlternatives = false;

            // Try each pattern to find alternatives
            for (let pattern of alternativePatterns) {
                const matches = [...text.matchAll(pattern)];

                if (matches.length > 0) {
                    foundAlternatives = true;

                    // Process each match as an alternative
                    for (let i = 0; i < matches.length; i++) {
                        // Clean and format the product name
                        const productName = matches[i][1].trim()
                            .replace(/[\*#]/g, '')     // Remove any remaining * and # characters
                            .replace(/\s+/g, ' ')     // Normalize whitespace
                            .trim();

                        // Find where this match starts and the next one begins
                        const startPos = matches[i].index + matches[i][0].length;
                        const endPos = (i < matches.length - 1) ? matches[i+1].index : text.length;

                        // Extract the content for this alternative
                        let content = text.substring(startPos, endPos).trim();

                        // Process the content to extract description and benefits
                        let description = '';
                        let benefits = '';

                        // Look for benefits section - search for common markers
                        const benefitMarkers = [
                            'Benefits:', 'Benefits include:', 'Health benefits:',
                            'Advantages:', 'Health advantages:', 'Benefits of'
                        ];

                        let benefitsStart = -1;

                        for (const marker of benefitMarkers) {
                            const index = content.indexOf(marker);
                            if (index !== -1) {
                                benefitsStart = index;
                                break;
                            }
                        }

                        // If we found a benefits marker, split the content
                        if (benefitsStart !== -1) {
                            description = content.substring(0, benefitsStart).trim();
                            benefits = content.substring(benefitsStart).trim();

                            // Remove the benefits marker from the benefits text
                            for (const marker of benefitMarkers) {
                                if (benefits.startsWith(marker)) {
                                    benefits = benefits.substring(marker.length).trim();
                                    break;
                                }
                            }
                        } else {
                            // If no explicit benefits section, check for benefit keywords in sentences
                            const sentences = content.split(/\.\s+/);
                            const descriptionSentences = [];
                            const benefitSentences = [];

                            for (const sentence of sentences) {
                                const lowerSentence = sentence.toLowerCase();
                                if (lowerSentence.includes('benefit') || 
                                    lowerSentence.includes('advantage') || 
                                    lowerSentence.includes('good for') || 
                                    lowerSentence.includes('health benefit') ||
                                    lowerSentence.includes('rich in')) {
                                    benefitSentences.push(sentence);
                                } else {
                                    descriptionSentences.push(sentence);
                                }
                            }

                            if (benefitSentences.length > 0) {
                                benefits = benefitSentences.join('. ');
                                if (!benefits.endsWith('.')) benefits += '.';

                                description = descriptionSentences.join('. ');
                                if (!description.endsWith('.') && description.length > 0) description += '.';
                            } else {
                                description = content;
                            }
                        }

                        // Final cleanup of description and benefits
                        description = description
                            .replace(/^\s*-\s*/, '')   // Remove leading dashes
                            .replace(/^\s*•\s*/, '')   // Remove leading bullets
                            .replace(/^\s*\d+\.\s*/, '') // Remove leading numbers
                            .trim();

                        benefits = benefits
                            .replace(/^\s*-\s*/, '')   // Remove leading dashes
                            .replace(/^\s*•\s*/, '')   // Remove leading bullets
                            .replace(/^\s*\d+\.\s*/, '') // Remove leading numbers
                            .trim();

                        // Add to alternatives array
                        alternatives.push({
                            name: toTitleCase(productName),
                            description: description,
                            benefits: benefits
                        });
                    }

                    // We found alternatives, no need to try other patterns
                    break;
                }
            }

            // If no structured alternatives were found, try a different approach
            if (!foundAlternatives) {
                // Try to split by empty lines (paragraphs)
                const paragraphs = text.split(/\n\s*\n/);

                // If we have multiple paragraphs, each might be an alternative
                if (paragraphs.length > 1) {
                    for (const paragraph of paragraphs) {
                        if (!paragraph.trim()) continue;

                        const lines = paragraph.split(/\n/);
                        let name = '';
                        let content = '';

                        // First line might contain the name
                        if (lines.length > 0) {
                            const firstLine = lines[0].trim()
                                .replace(/^\s*-\s*/, '')   // Remove leading dash
                                .replace(/^\s*•\s*/, '')   // Remove leading bullet
                                .replace(/^\s*\d+\.\s*/, ''); // Remove leading number

                            if (firstLine.includes(':')) {
                                // Name: Description format
                                const parts = firstLine.split(':');
                                name = parts[0].trim();
                                content = [parts.slice(1).join(':').trim(), ...lines.slice(1)].join(' ');
                            } else if (firstLine.length < 50) {
                                // Short first line is likely a name
                                name = firstLine;
                                content = lines.slice(1).join(' ');
                            } else {
                                // Extract a name from the beginning
                                const words = firstLine.split(/\s+/);
                                name = words.slice(0, Math.min(3, words.length)).join(' ');
                                content = [words.slice(Math.min(3, words.length)).join(' '), ...lines.slice(1)].join(' ');
                            }
                        }

                        // Extract benefits if present
                        let description = content;
                        let benefits = '';

                        const sentences = content.split(/\.\s+/);
                        const descriptionSentences = [];
                        const benefitSentences = [];

                        for (const sentence of sentences) {
                            const lowerSentence = sentence.toLowerCase();
                            if (lowerSentence.includes('benefit') || 
                                lowerSentence.includes('advantage') || 
                                lowerSentence.includes('good for') || 
                                lowerSentence.includes('health')) {
                                benefitSentences.push(sentence);
                            } else {
                                descriptionSentences.push(sentence);
                            }
                        }

                        if (benefitSentences.length > 0) {
                            benefits = benefitSentences.join('. ');
                            if (!benefits.endsWith('.') && benefits.length > 0) benefits += '.';

                            description = descriptionSentences.join('. ');
                            if (!description.endsWith('.') && description.length > 0) description += '.';
                        }

                        // Add to alternatives if we have a name
                        if (name) {
                            alternatives.push({
                                name: toTitleCase(name),
                                description: description.trim(),
                                benefits: benefits.trim()
                            });
                        }
                    }
                }
            }

            // If we still couldn't find alternatives, look for comma-separated list
            if (alternatives.length === 0) {
                const potentialListMatch = text.match(/(?:alternatives|substitutes|options)[^:]*?(?:include|are|such as):\s*([^\n]+)/i);

                if (potentialListMatch) {
                    const itemsList = potentialListMatch[1].split(/,\s*|\s+and\s+|\s+or\s+/).filter(item => item.trim().length > 0);

                    for (const item of itemsList) {
                        alternatives.push({
                            name: toTitleCase(item.trim()),
                            description: `A suitable alternative to the original ingredient.`,
                            benefits: ''
                        });
                    }
                }
            }

            // Final cleanup and validation
            for (let i = 0; i < alternatives.length; i++) {
                // If name contains description text, shorten it
                if (alternatives[i].name.length > 50) {
                    const words = alternatives[i].name.split(/\s+/);
                    alternatives[i].name = words.slice(0, 4).join(' ');
                }

                // If name is too short or generic, improve it
                if (alternatives[i].name.length < 3 || /^(option|alternative|substitute|item)/i.test(alternatives[i].name)) {
                    alternatives[i].name = `Alternative ${i+1}`;
                }

                // Make sure name is properly formatted
                alternatives[i].name = toTitleCase(alternatives[i].name);

                // Ensure description doesn't start with the name
                if (alternatives[i].description.toLowerCase().startsWith(alternatives[i].name.toLowerCase())) {
                    alternatives[i].description = alternatives[i].description.substring(alternatives[i].name.length).replace(/^[:\s,-]+/, '').trim();
                }
            }

            // If we still have no alternatives, create a generic one
            if (alternatives.length === 0) {
                alternatives.push({
                    name: 'Alternative Options',
                    description: text,
                    benefits: ''
                });
            }

            return alternatives;
        }

        // Helper function to convert text to Title Case
        function toTitleCase(text) {
            return text.replace(/\w\S*/g, function(txt) {
                // Don't capitalize small words like 'and', 'or', 'the', etc.
                const smallWords = /^(a|an|and|as|at|but|by|en|for|if|in|nor|of|on|or|per|the|to|vs?\.?|via)$/i;

                // Don't lowercase first or last word
                return txt.charAt(0).toUpperCase() + 
                       txt.substr(1).toLowerCase();
            });
        }

        // Improved helper function to parse LLM text responses into structured nutrition data
        function parseTextIntoNutrition(text, ingredientName) {
            // First clean up the entire text - remove markdown and normalize
            text = text
                .replace(/\*\*/g, '')      // Remove bold markdown
                .replace(/\*/g, '')        // Remove asterisks/italic markdown
                .replace(/^##+\s*/gm, '')  // Remove heading markers
                .trim();
            
            const result = {
                nutrition: [],
                benefits: [],
                description: ''
            };

            // First check for markdown headers
            const sections = {};
            let currentSection = 'intro';

            const lines = text.split(/\n+/);
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                // Check for section headers
                if (line.startsWith('## ') || line.match(/^nutritional values|^nutrition facts|^nutrient content/i)) {
                    currentSection = 'nutrition';
                    sections[currentSection] = [];
                    continue;
                } else if (line.match(/^health benefits|^benefits|^advantages/i)) {
                    currentSection = 'benefits';
                    sections[currentSection] = [];
                    continue;
                } else if (line.match(/^key information|^information|^description|^summary/i)) {
                    currentSection = 'info';
                    sections[currentSection] = [];
                    continue;
                }

                // Add content to current section
                if (!sections[currentSection]) {
                    sections[currentSection] = [];
                }
                sections[currentSection].push(line);
            }

            // Process nutritional values section
            const nutritionalSectionNames = ['nutrition', 'nutritional values', 'nutrition facts', 'nutrient content', 'nutritional information'];

            for (const sectionName of nutritionalSectionNames) {
                if (sections[sectionName]) {
                    for (const line of sections[sectionName]) {
                        // Clean the line first
                        const cleanLine = line
                            .replace(/^\s*-\s*|\s*•\s*|\s*\*\s*|\s*\d+\.\s*/g, '')
                            .trim();
                        
                        // Look for list items with values
                        const nutriMatch = cleanLine.match(/([^:]+):(.+)/) || cleanLine.match(/([^-]+)-(.+)/);
                        if (nutriMatch) {
                            const nutriName = nutriMatch[1].trim();
                            const value = nutriMatch[2].trim();

                            // Try to separate value and unit
                            const valueUnit = value.match(/^([\d.]+)\s*([a-zA-Z%]+)/);
                            if (valueUnit) {
                                result.nutrition.push({
                                    name: nutriName,
                                    value: valueUnit[1],
                                    unit: valueUnit[2]
                                });
                            } else {
                                result.nutrition.push({
                                    name: nutriName,
                                    value: value,
                                    unit: ''
                                });
                            }
                        }
                    }
                }
            }

            // Process health benefits section
            const benefitSectionNames = ['benefits', 'health benefits', 'advantages'];

            for (const sectionName of benefitSectionNames) {
                if (sections[sectionName]) {
                    for (const line of sections[sectionName]) {
                        // Clean up any benefit line completely
                        const cleanBenefit = line
                            .replace(/^\s*-\s*|\s*•\s*|\s*\*\s*|\s*\d+\.\s*/g, '') // Remove bullets/numbers/asterisks
                            .replace(/\s{2,}/g, ' ') // Normalize spaces
                            .trim();
                        
                        if (cleanBenefit) {
                            // Make sure benefit ends with proper punctuation
                            let formattedBenefit = cleanBenefit;
                            if (!formattedBenefit.endsWith('.') && !formattedBenefit.endsWith('!') && !formattedBenefit.endsWith('?')) {
                                formattedBenefit += '.';
                            }
                            
                            // Capitalize first letter if not already capitalized
                            formattedBenefit = formattedBenefit.charAt(0).toUpperCase() + formattedBenefit.slice(1);
                            
                            result.benefits.push(formattedBenefit);
                        }
                    }
                }
            }

            // Process key information section
            const infoSectionNames = ['info', 'key information', 'information', 'description', 'summary', 'intro'];

            // Look for description in any of the info sections
            for (const sectionName of infoSectionNames) {
                if (sections[sectionName] && sections[sectionName].length > 0) {
                    // Join all lines, clean up, and use as description
                    result.description = sections[sectionName]
                        .join(' ')
                        .replace(/\s+/g, ' ') // Normalize whitespace
                        .trim();
                    
                    // Once we find a description, no need to check other sections
                    if (result.description) break;
                }
            }

            // If no benefits were identified and we have description
            if (result.benefits.length === 0 && result.description) {
                // Try to identify sentences about benefits
                const sentences = result.description.split(/\.\s+/);
                for (let sentence of sentences) {
                    sentence = sentence.trim();
                    if (sentence.toLowerCase().includes('benefit') ||
                        sentence.toLowerCase().includes('good for') ||
                        sentence.toLowerCase().includes('health') ||
                        sentence.toLowerCase().includes('improve') ||
                        sentence.toLowerCase().includes('boost')) {
                        
                        // Clean and format
                        let cleanSentence = sentence
                            .replace(/\*/g, '')
                            .replace(/\s{2,}/g, ' ')
                            .trim();
                        
                        // Add proper ending punctuation if missing
                        if (!cleanSentence.endsWith('.') && !cleanSentence.endsWith('!') && !cleanSentence.endsWith('?')) {
                            cleanSentence += '.';
                        }
                        
                        // Capitalize first letter
                        cleanSentence = cleanSentence.charAt(0).toUpperCase() + cleanSentence.slice(1);
                        
                        result.benefits.push(cleanSentence);
                    }
                }
            }

            // Format nutrition items - capitalize first letter of each nutrient name
            result.nutrition = result.nutrition.map(item => ({
                name: item.name.charAt(0).toUpperCase() + item.name.slice(1).toLowerCase(),
                value: item.value,
                unit: item.unit
            }));

            return result;
        }

        // Enter key triggers search
        document.getElementById("alternativeInput").addEventListener("keypress", function (event) {
            if (event.key === "Enter") {
                event.preventDefault();
                document.getElementById("alternativeBtn").click();
            }
        });

        document.getElementById("nutritionInput").addEventListener("keypress", function (event) {
            if (event.key === "Enter") {
                event.preventDefault();
                document.getElementById("nutritionBtn").click();
            }
        });
    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>
{% endblock %}